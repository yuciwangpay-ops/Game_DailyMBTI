<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>PersonaPact å‘½é‹å¥‘ç´„</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { background-color: #1a1a1a; color: #fff; font-family: 'Noto Sans TC', sans-serif; padding: 20px; }
    .card { background-color: #2c2c2c; border: 1px solid #444; margin-bottom: 15px; }
    .btn-custom { width: 100%; margin-top: 10px; padding: 12px; }
    .hidden { display: none; }
    #loading { text-align: center; margin-top: 50px; }
  </style>
</head>
<body>

  <div id="loading">
    <div class="spinner-border text-light" role="status"></div>
    <p class="mt-2">æ­£åœ¨é€£çµè³‡æ–™åº«...</p>
    <small class="text-muted" id="debugMsg">åˆå§‹åŒ–...</small>
  </div>

  <div id="mainContent" class="hidden">
    <h3 class="mb-4">âš”ï¸ éŠæˆ²æ§åˆ¶å°</h3>
    <div class="card p-3">
        <p>æ­¡è¿, <span id="userName">...</span></p>
        <button class="btn btn-primary btn-custom" onclick="testBackend()">ğŸ“¡ æ¸¬è©¦å¾Œç«¯é€£ç·š</button>
    </div>
  </div>

  <script>
    // ==========================================
    // âš ï¸ è¨­å®šå€ (è«‹ä¿®æ”¹é€™è£¡)
    // ==========================================
    
    // 1. å¡«å…¥å‰›å‰› GAS éƒ¨ç½²æ‹¿åˆ°çš„ç¶²å€
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbw9ZPgiKFPj3iLi5z_3F40oJ2hKgFXFGPEvLfbbklX9oe3wWTiVaB8AnyRWdqrztFbdVA/exec"; 
    
    // 2. å¡«å…¥æ‚¨çš„ LIFF ID
    const LIFF_ID = "2008941439-M9ODe8F0;

    // ==========================================
    // ğŸš€ æ ¸å¿ƒé‚è¼¯
    // ==========================================
    
    async function main() {
      const debugEl = document.getElementById('debugMsg');
      
      try {
        debugEl.innerText = "æ­£åœ¨åˆå§‹åŒ– LIFF...";
        await liff.init({ liffId: LIFF_ID });
        
        if (!liff.isLoggedIn()) {
          debugEl.innerText = "ä½¿ç”¨è€…æœªç™»å…¥ï¼Œè·³è½‰ä¸­...";
          liff.login();
          return;
        }

        const profile = await liff.getProfile();
        document.getElementById('userName').innerText = profile.displayName;
        
        // é¡¯ç¤ºä¸»ç•«é¢
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('mainContent').classList.remove('hidden');

      } catch (err) {
        debugEl.innerText = "éŒ¯èª¤: " + err.message;
        alert("å•Ÿå‹•å¤±æ•—: " + err);
      }
    }

    // å‘¼å« GAS å¾Œç«¯
    async function testBackend() {
      if(GAS_API_URL.includes("è«‹è²¼ä¸Š")) {
        alert("è«‹å…ˆå» GitHub ç·¨è¼¯ index.html å¡«å…¥ GAS ç¶²å€ï¼");
        return;
      }

      try {
        const profile = await liff.getProfile();
        // ä½¿ç”¨ fetch ç™¼é€ POST è«‹æ±‚çµ¦ GAS
        // mode: 'no-cors' æˆ–è€…æ˜¯åˆ©ç”¨ GAS çš„ç‰¹æ€§ï¼Œé€šå¸¸ç›´æ¥ fetch å³å¯
        // GAS Web App å›å‚³çš„æ˜¯ 302 Redirectï¼Œfetch æœƒè‡ªå‹•è·Ÿéš¨
        
        const response = await fetch(GAS_API_URL, {
          method: "POST",
          body: JSON.stringify({ 
            action: "test_connection", // æˆ–æ˜¯ "createTeam"
            userId: profile.userId
          })
        });
        
        const result = await response.json();
        alert("å¾Œç«¯å›æ‡‰: " + JSON.stringify(result));
        
      } catch (e) {
        alert("é€£ç·šå¤±æ•—: " + e);
      }
    }

    // å•Ÿå‹•
    main();
  </script>
</body>
</html>